complementaryMappingTable$CONCEPT_NAME == "-" & complementaryMappingTable$CONCEPT_NAME %in% c("Allergy screening test", "DNA analysis", "Electromyography", "Hematoxylin stain method", "Mycobacterial microscopy", "Nerve conduction study", "Subcutaneous immunotherapy") ~ "Laboratory and Genetic Testing",
complementaryMappingTable$CONCEPT_NAME == "-" & complementaryMappingTable$CONCEPT_NAME %in% c("Diagnostic dermatoscopy of skin") ~ "Dermatologic Procedures",
complementaryMappingTable$CONCEPT_NAME == "-" & complementaryMappingTable$CONCEPT_NAME %in% c("Gynecologic examination", "Transvaginal echography", "Vaginal delivery of fetus") ~ "Gynecologic and Obstetric Procedures",
complementaryMappingTable$CONCEPT_NAME == "-" & complementaryMappingTable$CONCEPT_NAME %in% c("Individual psychotherapy") ~ "Psychotherapy and Mental Health Services",
TRUE ~ complementaryMappingTable$CONCEPT_NAME
)
complementaryMappingTable
data$selectedFeatures
data = CohortContrast(
connection,
connectionDetails,
cdmSchema,
cdmVocabSchema,
cdmTmpSchema,
pathToResults,
studyName,
domainsIncluded = c("Procedure", "Drug", "Condition"),
generateTables = FALSE,
readFromCSV = FALSE,
prevalenceCutOff = 1,
topDogs = 300,
presenceFilter = 0.025,
removeOutliers = FALSE,
complementaryMappingTable = FALSE
)
# VÃµta subjekt nr ka conditionite jaoks
length(unique(data$trajectoryData$SUBJECT_ID))
f = data$trajectoryData
length(unique(data$trajectoryData$SUBJECT_ID))
data$pcaPlot1
data$heatmapPlot1
data$selectedFeatureNames
data$trajectoryData$COHORT_DEFINITION_ID = trimws(data$trajectoryData$COHORT_DEFINITION_ID)
stateCohortLabels = setdiff(unique(data$trajectoryData$COHORT_DEFINITION_ID), c("0"))
stateCohortLabels = Cohort2Trajectory::sanitize_filenames(stateCohortLabels)
allowedStatesList = Cohort2Trajectory::createStateList(stateCohortLabels) # Creates a list allowing all transitions from each state
# topDogsList = c(20,50,100,500)
# presenceFilterList = c(0, 0.05, 0.1, 0.25)
csv_data <- read.csv('./inst/external/aniekStudy.csv', stringsAsFactors = FALSE)
features = data$selectedFeatures
# # Initialize a list to store match percentages for each combination of topDog and presenceFilter
match_percentages <- list()
results <- list()
features = data$selectedFeatures
feature_mappings <- list()
# Loop through each feature in features
for(i in 1:nrow(features)) {
# Current feature's CONCEPT_ID
current_feature <- features$CONCEPT_ID[i]
# Find matches in csv_data
matches <- csv_data[csv_data$concept_id == current_feature, ]
# Extract up to three 'name' values from the matches
match_names <- if (nrow(matches) > 0) {
matches$name[1:min(3, nrow(matches))]
} else {
character(0) # No matches found
}
# Fill remaining slots with "-" if there are fewer than three matches
if (length(match_names) < 3) {
match_names <- c(match_names, rep("-", 3 - length(match_names)))
}
# Assign the match names to the feature_mappings list
feature_mappings[[as.character(current_feature)]] <- match_names
}
feature_mappings
feature_mappings$`36405113`
feature_mappings$`2929383`[1] = "ICS all"
feature_mappings$`45892172`[1] = "Other"#"Type 2 Diabetes"
feature_mappings$`1107882`[1] = "Antihistamine"
feature_mappings$`1107830`[1] = "Antihistamine"
feature_mappings$`40242223`[1] = "Antihistamine"
feature_mappings$`44033346`[1] = "Anti-Inflammatory"
feature_mappings$`19073777`[1] = "Anti-Inflammatory"
feature_mappings$`1734107`[1] = "Anti-Inflammatory"
feature_mappings$`19008867`[1] = "Other"#"Mast cell stabilizers"
feature_mappings$`42657193`[1] = "Other"#"Mast cell stabilizers"
feature_mappings$`40992093`[1] = "ICS all"
feature_mappings$`43181576`[1] = "ICS all"
feature_mappings$`43181576`[2] = "LABA all"
feature_mappings$`36403656`[1] = "ICS all"
feature_mappings$`1149380`[1] = "ICS all"
feature_mappings$`36250122`[1] = "ICS all"
feature_mappings$`36119477`[1] = "ICS all"
feature_mappings$`2062176`[1] = "SABA all"
feature_mappings$`1343916`[1] = "SABA all"
feature_mappings$`19028902`[1] = "Other"#"DMARD"
feature_mappings$`1101898`[1] = "Other"#"DMARD"
feature_mappings$`1115678`[1] = "ICS all"
feature_mappings$`19037833`[1] = "Gastrointestinal"
feature_mappings$`19098138`[1] = "ICS all"
feature_mappings$`19060643`[1] = "ICS all"
feature_mappings$`19063315`[1] = "ICS all"
feature_mappings$`36890815`[1] = "Antihistamine"
feature_mappings$`19092433`[1] = "Antihistamine"
feature_mappings$`40175210`[1] = "Hypothyroidism"
feature_mappings$`1501700`[1] = "Hypothyroidism"
feature_mappings$`1140650`[1] = "Pain Killers"#"Pain Killers"
feature_mappings$`19008994`[1] = "Gastrointestinal"
feature_mappings$`19101741`[1] = "Gastrointestinal"
feature_mappings$`40162878`[1] = "Cardiovascular" #"Cardiovascular"
feature_mappings$`1338005`[1] = "Cardiovascular" #"Cardiovascular"
feature_mappings$`19101790`[1] = "Gastrointestinal"
feature_mappings$`19018403`[1] = "Gastrointestinal"
feature_mappings$`19103390`[1] = "Gastrointestinal"
feature_mappings$`40163630`[1] = "Antihistamine"
feature_mappings$`1136422`[1] = "Antihistamine"
feature_mappings$`40228214`[1] = "Antihistamine"
feature_mappings$`1149196`[1] = "Antihistamine"
feature_mappings$`43144461`[1] = "ICS all"
feature_mappings$`43144461`[1] = "Anti-Inflammatory"
feature_mappings$`36272383`[1] = "Anti-Inflammatory"
feature_mappings$`991825`[1] = "Gastrointestinal"
feature_mappings$`19106931`[1] = "Gastrointestinal"
feature_mappings$`21158991`[1] = "Antihistamine"
feature_mappings$`36879144`[1] = "Antihistamine"
feature_mappings$`40029531`[1] = "Pain Killers"#"Painkiller"
feature_mappings$`915855`[1] = "Antihistamine"
feature_mappings$`40240035`[1] = "Antihistamine"
feature_mappings$`1103006`[1] = "Antihistamine"
feature_mappings$`19096758`[1] = "Antihistamine"
feature_mappings$`44033226`[1] = "Antihistamine"
feature_mappings$`44012547`[1] = "Antihistamine"
feature_mappings$`43013030`[1] = "Cardiovascular" #"Cardiovascular"
feature_mappings$`797399`[1] = "Other" #"neuropathic pain"
feature_mappings$`19077548`[1] = "Other" #"neuropathic pain"
feature_mappings$`904456`[1] = "Gastrointestinal"
feature_mappings$`19101745`[1] = "Gastrointestinal"
feature_mappings$`19101746`[1] = "Gastrointestinal"
feature_mappings$`40992339`[1] = "Gastrointestinal"
feature_mappings$`904453`[1] = "Gastrointestinal"
feature_mappings$`1734104`[1] = "Anti-Inflammatory"
feature_mappings$`1734134`[1] = "Anti-Inflammatory"
feature_mappings$`40169766`[1] = "Hypothyroidism"
feature_mappings$`19112671`[1] = "Pain Killers" #"neuropathic pain"
feature_mappings$`734354`[1] = "Pain Killers" #"neuropathic pain"
feature_mappings$`739209`[1] = "Other" #"Depression"
feature_mappings$`739138`[1] = "Other" #"Depression"
feature_mappings$`41180028`[1] = "Other" #"Depression"
feature_mappings$`715259`[1] = "Other" #"Depression"
feature_mappings$`1353256`[1] = "Cardiovascular" #"Cardiovascular"
feature_mappings$`970283`[1] = "Cardiovascular" #"Cardiovascular"
feature_mappings$`905233`[1] = "ICS all"
feature_mappings$`41147520`[1] = "ICS all"
feature_mappings$`43709033`[1] = "Anti-Inflammatory"
feature_mappings$`43691172`[1] = "Anti-Inflammatory"
feature_mappings$`43691172`[1] = "Anti-Inflammatory"
feature_mappings$`43691172`[1] = "Anti-Inflammatory"
feature_mappings$`778478`[1] = "Other"#muscle relaxants
feature_mappings$`778474`[1] = "Other"#muscle relaxants
feature_mappings$`1351557`[1] = "Cardiovascular" #"Cardiovascular"
feature_mappings$`41271459`[1] = "Gastrointestinal"
feature_mappings$`948078`[1] = "Gastrointestinal"
feature_mappings$`41302588`[1] = "Gastrointestinal"
feature_mappings$`36782737`[1] = "Other"# Influenza vaccination
feature_mappings$`40164516`[1] = "Anti-Inflammatory"
feature_mappings$`998415`[1] = "Anti-Inflammatory"
feature_mappings$`1750562`[1] = "Antibiotics"#Antibiotics
feature_mappings$`1750500`[1] = "Antibiotics"#Antibiotics
feature_mappings$`36259665`[1] = "Other"#Joints
feature_mappings$`1506270`[1] = "Systemic glucocorticoids all"
feature_mappings$`40835197`[1] = "Systemic glucocorticoids all"
feature_mappings$`1799141`[1] = "Other"# Influenza vaccination
feature_mappings$`1799139`[1] = "Other"# Influenza vaccination
feature_mappings$`906891`[1] = "Gastrointestinal"
feature_mappings$`906780`[1] = "Gastrointestinal"
feature_mappings$`40221938`[1] = "Pain Killers"# Painkiller
feature_mappings$`1125315`[1] = "Pain Killers"# Painkiller
feature_mappings$`1201620`[1] = "Pain Killers"#"Painkiller"
feature_mappings$`40221938`[1] = "Pain Killers"#"Painkiller"
feature_mappings$`40029531`[1] = "Pain Killers"#"Painkiller"
feature_mappings$`725131`[1] = "Other" #"Depression"
feature_mappings$`40234038`[1] = "Anti-Inflammatory"
feature_mappings$`19028935`[1] = "Cardiovascular" #"Cardiovascular"
feature_mappings$`1317640`[1] = "Cardiovascular" #"Cardiovascular"
feature_mappings$`40228219`[1] = "Antihistamine"
feature_mappings$`19056611`[1] = "Gastrointestinal"
feature_mappings$`978555`[1] = "Cardiovascular" #"Cardiovascular"
feature_mappings$`19101674`[1] = "Anti-Inflammatory"
feature_mappings$`19011355`[1] = "Anti-Inflammatory"
feature_mappings$`43139267`[1] = "Other" # Bowel surgical preparation
feature_mappings$`19072934`[1] = "Other"#Anxiety
feature_mappings$`781039`[1] = "Other"#Anxiety
feature_mappings$`19005626`[1] = "Cardiovascular" #"Cardiovascular"
feature_mappings$`40744371`[1] = "Cardiovascular" #"Cardiovascular"
feature_mappings$`942382`[1] = "Cardiovascular" #"Cardiovascular"
feature_mappings$`942350`[1] = "Cardiovascular" #"Cardiovascular"
feature_mappings$`35407482`[1] = "Other"#Anxiety
feature_mappings$`723013`[1] = "Other"#Anxiety
feature_mappings$`43585629`[1] = "Anti-Inflammatory"
feature_mappings$`1778162`[1] = "Antibiotics"#Antibiotics
feature_mappings$`19075002`[1] ="Antibiotics"#Antibiotics
feature_mappings$`1314577`[1] = "Cardiovascular" #"Cardiovascular"
feature_mappings$`19101573`[1] = "Cardiovascular" #"Cardiovascular"
feature_mappings$`1103314`[1] = "Other"#"Painkiller"
feature_mappings$`1373225`[1] = "Cardiovascular" #"Cardiovascular"
feature_mappings$`1185922`[1] = "Anti-Inflammatory"
feature_mappings$`1713412`[1] = "Antibiotics"#Antibiotics
feature_mappings$`19115197`[1] ="Antibiotics"#Antibiotics
feature_mappings$`1713332`[1] = "Antibiotics"#Antibiotics
feature_mappings$`1150345`[1] = "Anti-Inflammatory"
feature_mappings$`1332418`[1] = "Cardiovascular" #"Cardiovascular"
feature_mappings$`0`[1] = "Other" #"Unmapped"
feature_mappings$`43769274`[1] = "Gastrointestinal"
feature_mappings$`923645`[1] = "Gastrointestinal"
feature_mappings$`43769269`[1] = "Gastrointestinal"
feature_mappings$`1115008`[1] = "Anti-Inflammatory"
feature_mappings$`1506426`
concept_ids <- numeric(length(feature_mappings))
concept_names <- character(length(feature_mappings))
# Loop through each item in the list
i <- 1
for(concept_id in names(feature_mappings)) {
# Store the concept ID
concept_ids[i] <- as.numeric(concept_id)
# Concatenate the concept names, ignoring "-"
#concept_names[i] <- paste(feature_mappings[[concept_id]][feature_mappings[[concept_id]] != "-"], collapse = " + ")
concept_names[i] <- paste(feature_mappings[[concept_id]][1])
i <- i + 1
}
# Create a dataframe
complementaryMappingTable <- data.frame(CONCEPT_ID = concept_ids, CONCEPT_NAME = concept_names)
complementaryMappingTable$CONCEPT_NAME = as.vector(Cohort2Trajectory::sanitize_filenames(complementaryMappingTable$CONCEPT_NAME))
complementaryMappingTable = complementaryMappingTable %>% mutate(CONCEPT_NAME = ifelse(CONCEPT_NAME %in% c("Xanthines_all", "SAMA_all", "Systemic_B2_agonist_all", "LTRA_all"), "Asthma Other", CONCEPT_NAME))
complementaryMappingTable
complementaryMappingTable = complementaryMappingTable %>% mutate(CONCEPT_NAME = ifelse(CONCEPT_NAME %in% c("Xanthines_all", "SAMA_all", "Systemic_B2_agonist_all", "LTRA_all"), "Asthma Other", CONCEPT_NAME)) %>% filter(CONCEPT_NAME != "-")
complementaryMappingTable
dataConditionProc = data$selectedFeatures
# Assuming your dataframe is named df
dataConditionProc$CONCEPT_NAME <- case_when(
complementaryMappingTable$CONCEPT_NAME %in% c("Abnormal breathing", "Acute bronchitis", "Acute mycoplasmal bronchitis", "Allergic rhinitis", "Allergic rhinitis due to pollen", "Atrial premature complex", "Bronchiectasis", "Bronchitis", "Chronic bronchitis", "Chronic disease of tonsils AND/OR adenoids", "Chronic ethmoidal sinusitis", "Chronic laryngitis", "Chronic laryngitis and laryngotracheitis", "Chronic laryngotracheitis", "Chronic maxillary sinusitis", "Chronic nasopharyngitis", "Chronic pansinusitis", "Chronic pharyngitis", "Chronic respiratory failure", "Chronic rhinitis", "Chronic sinusitis", "Cough", "Disease of the respiratory system complicating pregnancy, childbirth and/or the puerperium", "Disorder of the larynx", "Dysphonia", "Dyspnea", "Mixed simple and mucopurulent chronic bronchitis", "Mouth breathing", "Mucopurulent chronic bronchitis", "Pneumonia due to respiratory syncytial virus", "Polyp of nasal cavity", "Polyp of nasal sinus", "Polypoid sinus degeneration", "Pulmonary sarcoidosis", "Rheumatic fever", "Rheumatoid vasculitis", "Rhinitis", "Sarcoidosis", "Seasonal allergic rhinitis", "Simple chronic bronchitis", "Sleep apnea", "Upper respiratory tract hypersensitivity reaction", "Vasomotor rhinitis") ~ "Respiratory Conditions",
complementaryMappingTable$CONCEPT_NAME %in% c("Acute atopic conjunctivitis", "Allergic contact dermatitis due to metal", "Allergic disposition", "Allergic rhinitis", "Allergic rhinitis due to pollen", "Seasonal allergic rhinitis", "Upper respiratory tract hypersensitivity reaction", "Vasomotor rhinitis") ~ "Allergies and Immune Disorders",
complementaryMappingTable$CONCEPT_NAME %in% c("Gastro-esophageal reflux disease with esophagitis", "Gastroesophageal reflux disease", "Gastroesophageal reflux disease without esophagitis", "Irritable bowel syndrome", "Irritable bowel syndrome with diarrhea") ~ "Gastrointestinal Disorders",
complementaryMappingTable$CONCEPT_NAME %in% c("Autoimmune thyroiditis", "Hypothyroidism", "Non-toxic multinodular goiter", "Disorder of bilirubin metabolism") ~ "Thyroid and Metabolic Disorders",
complementaryMappingTable$CONCEPT_NAME %in% c("Generalized anxiety disorder", "Chronic intractable pain", "Chronic pain", "Migraine without aura", "Obesity", "Pain", "Panic disorder", "Simple obesity", "Spinal stenosis", "Voice production finding") ~ "Mental and Neurological Disorders",
complementaryMappingTable$CONCEPT_NAME %in% c("Acoustic reflex testing", "Audiometric test", "Bone density scan", "Bronchoscopy", "Colonoscopy", "Computerized axial tomography", "CT without contrast", "Diagnostic dermatoscopy of skin", "DNA analysis", "Echocardiography", "Electromyography", "Endoscopic biopsy", "Endoscopic biopsy of stomach", "Esophagogastroduodenoscopy", "Evaluation of biopsy specimen", "Functional endoscopic sinus surgery - anterior ethmoidectomy and frontal recess dissection", "Magnetic resonance imaging", "Magnetic resonance imaging (MRI) of vessels", "Mammography", "Microlaryngoscopy", "Optical coherence tomography of eye region", "Pelvis X-ray", "Plain chest X-ray", "Radiographic imaging procedure", "Radiography of face, head AND/OR neck", "Radiography of spine", "Refraction assessment", "Slit lamp fundus examination", "Transvaginal echography", "Tympanometry testing", "Ultrasonography of soft tissue", "Ultrasound procedure on cardiovascular system", "US scan of abdomen and pelvis", "US scan of thyroid", "X-ray of limb", "Water soluble eosin stain method") ~ "Diagnostic Imaging",
complementaryMappingTable$CONCEPT_NAME %in% c("Bronchoscopy", "Colonoscopy", "Endoscopic biopsy", "Endoscopic biopsy of stomach", "Endoscopic ethmoidectomy", "Endoscopy of nose", "Endoscopy of stomach", "Esophagogastroduodenoscopy", "Functional endoscopic sinus surgery - anterior ethmoidectomy and frontal recess dissection", "Nasal endoscopy with maxillary antrostomy") ~ "Endoscopic Procedures",
complementaryMappingTable$CONCEPT_NAME %in% c("Electrocardiogram with exercise test", "Electrocardiographic monitoring", "Holter extended electrocardiographic recording", "Magnetic resonance imaging (MRI) of vessels", "Ultrasound procedure on cardiovascular system") ~ "Cardiovascular Assessments",
complementaryMappingTable$CONCEPT_NAME %in% c("Bronchoscopy", "Diagnostic procedure on upper respiratory tract", "Direct laryngoscopy", "Indirect laryngoscopy", "Microlaryngoscopy", "Puncture procedure") ~ "Respiratory Procedures",
complementaryMappingTable$CONCEPT_NAME %in% c("Allergy screening test", "DNA analysis", "Electromyography", "Hematoxylin stain method", "Mycobacterial microscopy", "Nerve conduction study", "Subcutaneous immunotherapy") ~ "Laboratory and Genetic Testing",
complementaryMappingTable$CONCEPT_NAME %in% c("Diagnostic dermatoscopy of skin") ~ "Dermatologic Procedures",
complementaryMappingTable$CONCEPT_NAME %in% c("Gynecologic examination", "Transvaginal echography", "Vaginal delivery of fetus") ~ "Gynecologic and Obstetric Procedures",
ccomplementaryMappingTable$CONCEPT_NAME %in% c("Individual psychotherapy") ~ "Psychotherapy and Mental Health Services"
#TRUE ~ complementaryMappingTable$CONCEPT_NAME
)
# Assuming your dataframe is named df
dataConditionProc$CONCEPT_NAME <- case_when(
complementaryMappingTable$CONCEPT_NAME %in% c("Abnormal breathing", "Acute bronchitis", "Acute mycoplasmal bronchitis", "Allergic rhinitis", "Allergic rhinitis due to pollen", "Atrial premature complex", "Bronchiectasis", "Bronchitis", "Chronic bronchitis", "Chronic disease of tonsils AND/OR adenoids", "Chronic ethmoidal sinusitis", "Chronic laryngitis", "Chronic laryngitis and laryngotracheitis", "Chronic laryngotracheitis", "Chronic maxillary sinusitis", "Chronic nasopharyngitis", "Chronic pansinusitis", "Chronic pharyngitis", "Chronic respiratory failure", "Chronic rhinitis", "Chronic sinusitis", "Cough", "Disease of the respiratory system complicating pregnancy, childbirth and/or the puerperium", "Disorder of the larynx", "Dysphonia", "Dyspnea", "Mixed simple and mucopurulent chronic bronchitis", "Mouth breathing", "Mucopurulent chronic bronchitis", "Pneumonia due to respiratory syncytial virus", "Polyp of nasal cavity", "Polyp of nasal sinus", "Polypoid sinus degeneration", "Pulmonary sarcoidosis", "Rheumatic fever", "Rheumatoid vasculitis", "Rhinitis", "Sarcoidosis", "Seasonal allergic rhinitis", "Simple chronic bronchitis", "Sleep apnea", "Upper respiratory tract hypersensitivity reaction", "Vasomotor rhinitis") ~ "Respiratory Conditions",
complementaryMappingTable$CONCEPT_NAME %in% c("Acute atopic conjunctivitis", "Allergic contact dermatitis due to metal", "Allergic disposition", "Allergic rhinitis", "Allergic rhinitis due to pollen", "Seasonal allergic rhinitis", "Upper respiratory tract hypersensitivity reaction", "Vasomotor rhinitis") ~ "Allergies and Immune Disorders",
complementaryMappingTable$CONCEPT_NAME %in% c("Gastro-esophageal reflux disease with esophagitis", "Gastroesophageal reflux disease", "Gastroesophageal reflux disease without esophagitis", "Irritable bowel syndrome", "Irritable bowel syndrome with diarrhea") ~ "Gastrointestinal Disorders",
complementaryMappingTable$CONCEPT_NAME %in% c("Autoimmune thyroiditis", "Hypothyroidism", "Non-toxic multinodular goiter", "Disorder of bilirubin metabolism") ~ "Thyroid and Metabolic Disorders",
complementaryMappingTable$CONCEPT_NAME %in% c("Generalized anxiety disorder", "Chronic intractable pain", "Chronic pain", "Migraine without aura", "Obesity", "Pain", "Panic disorder", "Simple obesity", "Spinal stenosis", "Voice production finding") ~ "Mental and Neurological Disorders",
complementaryMappingTable$CONCEPT_NAME %in% c("Acoustic reflex testing", "Audiometric test", "Bone density scan", "Bronchoscopy", "Colonoscopy", "Computerized axial tomography", "CT without contrast", "Diagnostic dermatoscopy of skin", "DNA analysis", "Echocardiography", "Electromyography", "Endoscopic biopsy", "Endoscopic biopsy of stomach", "Esophagogastroduodenoscopy", "Evaluation of biopsy specimen", "Functional endoscopic sinus surgery - anterior ethmoidectomy and frontal recess dissection", "Magnetic resonance imaging", "Magnetic resonance imaging (MRI) of vessels", "Mammography", "Microlaryngoscopy", "Optical coherence tomography of eye region", "Pelvis X-ray", "Plain chest X-ray", "Radiographic imaging procedure", "Radiography of face, head AND/OR neck", "Radiography of spine", "Refraction assessment", "Slit lamp fundus examination", "Transvaginal echography", "Tympanometry testing", "Ultrasonography of soft tissue", "Ultrasound procedure on cardiovascular system", "US scan of abdomen and pelvis", "US scan of thyroid", "X-ray of limb", "Water soluble eosin stain method") ~ "Diagnostic Imaging",
complementaryMappingTable$CONCEPT_NAME %in% c("Bronchoscopy", "Colonoscopy", "Endoscopic biopsy", "Endoscopic biopsy of stomach", "Endoscopic ethmoidectomy", "Endoscopy of nose", "Endoscopy of stomach", "Esophagogastroduodenoscopy", "Functional endoscopic sinus surgery - anterior ethmoidectomy and frontal recess dissection", "Nasal endoscopy with maxillary antrostomy") ~ "Endoscopic Procedures",
complementaryMappingTable$CONCEPT_NAME %in% c("Electrocardiogram with exercise test", "Electrocardiographic monitoring", "Holter extended electrocardiographic recording", "Magnetic resonance imaging (MRI) of vessels", "Ultrasound procedure on cardiovascular system") ~ "Cardiovascular Assessments",
complementaryMappingTable$CONCEPT_NAME %in% c("Bronchoscopy", "Diagnostic procedure on upper respiratory tract", "Direct laryngoscopy", "Indirect laryngoscopy", "Microlaryngoscopy", "Puncture procedure") ~ "Respiratory Procedures",
complementaryMappingTable$CONCEPT_NAME %in% c("Allergy screening test", "DNA analysis", "Electromyography", "Hematoxylin stain method", "Mycobacterial microscopy", "Nerve conduction study", "Subcutaneous immunotherapy") ~ "Laboratory and Genetic Testing",
complementaryMappingTable$CONCEPT_NAME %in% c("Diagnostic dermatoscopy of skin") ~ "Dermatologic Procedures",
complementaryMappingTable$CONCEPT_NAME %in% c("Gynecologic examination", "Transvaginal echography", "Vaginal delivery of fetus") ~ "Gynecologic and Obstetric Procedures",
complementaryMappingTable$CONCEPT_NAME %in% c("Individual psychotherapy") ~ "Psychotherapy and Mental Health Services"
#TRUE ~ complementaryMappingTable$CONCEPT_NAME
)
# Assuming your dataframe is named df
dataConditionProc$CONCEPT_NAME <- case_when(
dataConditionProc$CONCEPT_NAME %in% c("Abnormal breathing", "Acute bronchitis", "Acute mycoplasmal bronchitis", "Allergic rhinitis", "Allergic rhinitis due to pollen", "Atrial premature complex", "Bronchiectasis", "Bronchitis", "Chronic bronchitis", "Chronic disease of tonsils AND/OR adenoids", "Chronic ethmoidal sinusitis", "Chronic laryngitis", "Chronic laryngitis and laryngotracheitis", "Chronic laryngotracheitis", "Chronic maxillary sinusitis", "Chronic nasopharyngitis", "Chronic pansinusitis", "Chronic pharyngitis", "Chronic respiratory failure", "Chronic rhinitis", "Chronic sinusitis", "Cough", "Disease of the respiratory system complicating pregnancy, childbirth and/or the puerperium", "Disorder of the larynx", "Dysphonia", "Dyspnea", "Mixed simple and mucopurulent chronic bronchitis", "Mouth breathing", "Mucopurulent chronic bronchitis", "Pneumonia due to respiratory syncytial virus", "Polyp of nasal cavity", "Polyp of nasal sinus", "Polypoid sinus degeneration", "Pulmonary sarcoidosis", "Rheumatic fever", "Rheumatoid vasculitis", "Rhinitis", "Sarcoidosis", "Seasonal allergic rhinitis", "Simple chronic bronchitis", "Sleep apnea", "Upper respiratory tract hypersensitivity reaction", "Vasomotor rhinitis") ~ "Respiratory Conditions",
dataConditionProc$CONCEPT_NAME %in% c("Acute atopic conjunctivitis", "Allergic contact dermatitis due to metal", "Allergic disposition", "Allergic rhinitis", "Allergic rhinitis due to pollen", "Seasonal allergic rhinitis", "Upper respiratory tract hypersensitivity reaction", "Vasomotor rhinitis") ~ "Allergies and Immune Disorders",
dataConditionProc$CONCEPT_NAME %in% c("Gastro-esophageal reflux disease with esophagitis", "Gastroesophageal reflux disease", "Gastroesophageal reflux disease without esophagitis", "Irritable bowel syndrome", "Irritable bowel syndrome with diarrhea") ~ "Gastrointestinal Disorders",
dataConditionProc$CONCEPT_NAME %in% c("Autoimmune thyroiditis", "Hypothyroidism", "Non-toxic multinodular goiter", "Disorder of bilirubin metabolism") ~ "Thyroid and Metabolic Disorders",
dataConditionProc$CONCEPT_NAME %in% c("Generalized anxiety disorder", "Chronic intractable pain", "Chronic pain", "Migraine without aura", "Obesity", "Pain", "Panic disorder", "Simple obesity", "Spinal stenosis", "Voice production finding") ~ "Mental and Neurological Disorders",
dataConditionProc$CONCEPT_NAME %in% c("Acoustic reflex testing", "Audiometric test", "Bone density scan", "Bronchoscopy", "Colonoscopy", "Computerized axial tomography", "CT without contrast", "Diagnostic dermatoscopy of skin", "DNA analysis", "Echocardiography", "Electromyography", "Endoscopic biopsy", "Endoscopic biopsy of stomach", "Esophagogastroduodenoscopy", "Evaluation of biopsy specimen", "Functional endoscopic sinus surgery - anterior ethmoidectomy and frontal recess dissection", "Magnetic resonance imaging", "Magnetic resonance imaging (MRI) of vessels", "Mammography", "Microlaryngoscopy", "Optical coherence tomography of eye region", "Pelvis X-ray", "Plain chest X-ray", "Radiographic imaging procedure", "Radiography of face, head AND/OR neck", "Radiography of spine", "Refraction assessment", "Slit lamp fundus examination", "Transvaginal echography", "Tympanometry testing", "Ultrasonography of soft tissue", "Ultrasound procedure on cardiovascular system", "US scan of abdomen and pelvis", "US scan of thyroid", "X-ray of limb", "Water soluble eosin stain method") ~ "Diagnostic Imaging",
dataConditionProc$CONCEPT_NAME %in% c("Bronchoscopy", "Colonoscopy", "Endoscopic biopsy", "Endoscopic biopsy of stomach", "Endoscopic ethmoidectomy", "Endoscopy of nose", "Endoscopy of stomach", "Esophagogastroduodenoscopy", "Functional endoscopic sinus surgery - anterior ethmoidectomy and frontal recess dissection", "Nasal endoscopy with maxillary antrostomy") ~ "Endoscopic Procedures",
dataConditionProc$CONCEPT_NAME %in% c("Electrocardiogram with exercise test", "Electrocardiographic monitoring", "Holter extended electrocardiographic recording", "Magnetic resonance imaging (MRI) of vessels", "Ultrasound procedure on cardiovascular system") ~ "Cardiovascular Assessments",
dataConditionProc$CONCEPT_NAME %in% c("Bronchoscopy", "Diagnostic procedure on upper respiratory tract", "Direct laryngoscopy", "Indirect laryngoscopy", "Microlaryngoscopy", "Puncture procedure") ~ "Respiratory Procedures",
dataConditionProc$CONCEPT_NAME %in% c("Allergy screening test", "DNA analysis", "Electromyography", "Hematoxylin stain method", "Mycobacterial microscopy", "Nerve conduction study", "Subcutaneous immunotherapy") ~ "Laboratory and Genetic Testing",
dataConditionProc$CONCEPT_NAME %in% c("Diagnostic dermatoscopy of skin") ~ "Dermatologic Procedures",
dataConditionProc$CONCEPT_NAME %in% c("Gynecologic examination", "Transvaginal echography", "Vaginal delivery of fetus") ~ "Gynecologic and Obstetric Procedures",
dataConditionProc$CONCEPT_NAME %in% c("Individual psychotherapy") ~ "Psychotherapy and Mental Health Services"
#TRUE ~ complementaryMappingTable$CONCEPT_NAME
)
dataConditionProc
dataConditionProc = dataConditionProc %>% filter(is.na(CONCEPT_NAME)) %>% select(CONCEPT_ID, CONCEPT_NAME)
dataConditionProc
dataConditionProc = data$selectedFeatures
# Assuming your dataframe is named df
dataConditionProc$CONCEPT_NAME <- case_when(
dataConditionProc$CONCEPT_NAME %in% c("Abnormal breathing", "Acute bronchitis", "Acute mycoplasmal bronchitis", "Allergic rhinitis", "Allergic rhinitis due to pollen", "Atrial premature complex", "Bronchiectasis", "Bronchitis", "Chronic bronchitis", "Chronic disease of tonsils AND/OR adenoids", "Chronic ethmoidal sinusitis", "Chronic laryngitis", "Chronic laryngitis and laryngotracheitis", "Chronic laryngotracheitis", "Chronic maxillary sinusitis", "Chronic nasopharyngitis", "Chronic pansinusitis", "Chronic pharyngitis", "Chronic respiratory failure", "Chronic rhinitis", "Chronic sinusitis", "Cough", "Disease of the respiratory system complicating pregnancy, childbirth and/or the puerperium", "Disorder of the larynx", "Dysphonia", "Dyspnea", "Mixed simple and mucopurulent chronic bronchitis", "Mouth breathing", "Mucopurulent chronic bronchitis", "Pneumonia due to respiratory syncytial virus", "Polyp of nasal cavity", "Polyp of nasal sinus", "Polypoid sinus degeneration", "Pulmonary sarcoidosis", "Rheumatic fever", "Rheumatoid vasculitis", "Rhinitis", "Sarcoidosis", "Seasonal allergic rhinitis", "Simple chronic bronchitis", "Sleep apnea", "Upper respiratory tract hypersensitivity reaction", "Vasomotor rhinitis") ~ "Respiratory Conditions",
dataConditionProc$CONCEPT_NAME %in% c("Acute atopic conjunctivitis", "Allergic contact dermatitis due to metal", "Allergic disposition", "Allergic rhinitis", "Allergic rhinitis due to pollen", "Seasonal allergic rhinitis", "Upper respiratory tract hypersensitivity reaction", "Vasomotor rhinitis") ~ "Allergies and Immune Disorders",
dataConditionProc$CONCEPT_NAME %in% c("Gastro-esophageal reflux disease with esophagitis", "Gastroesophageal reflux disease", "Gastroesophageal reflux disease without esophagitis", "Irritable bowel syndrome", "Irritable bowel syndrome with diarrhea") ~ "Gastrointestinal Disorders",
dataConditionProc$CONCEPT_NAME %in% c("Autoimmune thyroiditis", "Hypothyroidism", "Non-toxic multinodular goiter", "Disorder of bilirubin metabolism") ~ "Thyroid and Metabolic Disorders",
dataConditionProc$CONCEPT_NAME %in% c("Generalized anxiety disorder", "Chronic intractable pain", "Chronic pain", "Migraine without aura", "Obesity", "Pain", "Panic disorder", "Simple obesity", "Spinal stenosis", "Voice production finding") ~ "Mental and Neurological Disorders",
dataConditionProc$CONCEPT_NAME %in% c("Acoustic reflex testing", "Audiometric test", "Bone density scan", "Bronchoscopy", "Colonoscopy", "Computerized axial tomography", "CT without contrast", "Diagnostic dermatoscopy of skin", "DNA analysis", "Echocardiography", "Electromyography", "Endoscopic biopsy", "Endoscopic biopsy of stomach", "Esophagogastroduodenoscopy", "Evaluation of biopsy specimen", "Functional endoscopic sinus surgery - anterior ethmoidectomy and frontal recess dissection", "Magnetic resonance imaging", "Magnetic resonance imaging (MRI) of vessels", "Mammography", "Microlaryngoscopy", "Optical coherence tomography of eye region", "Pelvis X-ray", "Plain chest X-ray", "Radiographic imaging procedure", "Radiography of face, head AND/OR neck", "Radiography of spine", "Refraction assessment", "Slit lamp fundus examination", "Transvaginal echography", "Tympanometry testing", "Ultrasonography of soft tissue", "Ultrasound procedure on cardiovascular system", "US scan of abdomen and pelvis", "US scan of thyroid", "X-ray of limb", "Water soluble eosin stain method") ~ "Diagnostic Imaging",
dataConditionProc$CONCEPT_NAME %in% c("Bronchoscopy", "Colonoscopy", "Endoscopic biopsy", "Endoscopic biopsy of stomach", "Endoscopic ethmoidectomy", "Endoscopy of nose", "Endoscopy of stomach", "Esophagogastroduodenoscopy", "Functional endoscopic sinus surgery - anterior ethmoidectomy and frontal recess dissection", "Nasal endoscopy with maxillary antrostomy") ~ "Endoscopic Procedures",
dataConditionProc$CONCEPT_NAME %in% c("Electrocardiogram with exercise test", "Electrocardiographic monitoring", "Holter extended electrocardiographic recording", "Magnetic resonance imaging (MRI) of vessels", "Ultrasound procedure on cardiovascular system") ~ "Cardiovascular Assessments",
dataConditionProc$CONCEPT_NAME %in% c("Bronchoscopy", "Diagnostic procedure on upper respiratory tract", "Direct laryngoscopy", "Indirect laryngoscopy", "Microlaryngoscopy", "Puncture procedure") ~ "Respiratory Procedures",
dataConditionProc$CONCEPT_NAME %in% c("Allergy screening test", "DNA analysis", "Electromyography", "Hematoxylin stain method", "Mycobacterial microscopy", "Nerve conduction study", "Subcutaneous immunotherapy") ~ "Laboratory and Genetic Testing",
dataConditionProc$CONCEPT_NAME %in% c("Diagnostic dermatoscopy of skin") ~ "Dermatologic Procedures",
dataConditionProc$CONCEPT_NAME %in% c("Gynecologic examination", "Transvaginal echography", "Vaginal delivery of fetus") ~ "Gynecologic and Obstetric Procedures",
dataConditionProc$CONCEPT_NAME %in% c("Individual psychotherapy") ~ "Psychotherapy and Mental Health Services"
#TRUE ~ complementaryMappingTable$CONCEPT_NAME
)
dataConditionProc = dataConditionProc %>% filter(!is.na(CONCEPT_NAME)) %>% select(CONCEPT_ID, CONCEPT_NAME)
dataConditionProc
#complementaryMappingTable2 = dplyr::select(data$selectedFeatures, CONCEPT_ID, CONCEPT_NAME)
complementaryMappingTable = rbind(complementaryMappingTable,dataConditionProc)
complementaryMappingTable
#complementaryMappingTable2 = dplyr::select(data$selectedFeatures, CONCEPT_ID, CONCEPT_NAME)
complementaryMappingTable = rbind(complementaryMappingTable,dataConditionProc) %>% distinct()
complementaryMappingTable
print(complementaryMappingTable)
complementaryMappingTable$CONCEPT_NAME[is.na(complementaryMappingTable$CONCEPT_NAME)] = "Other"
dataMapped = CohortContrast(
connection,
connectionDetails,
cdmSchema,
cdmVocabSchema,
cdmTmpSchema,
pathToResults,
studyName,
domainsIncluded = c("Condition", "Drug", "Procedure"),##c("Drug", "Condition", "Measurement", "Observation", "Procedure"),
generateTables = FALSE,
readFromCSV = FALSE,
prevalenceCutOff = 1,
topDogs = 240,
presenceFilter = 0.025,
removeOutliers = FALSE,
complementaryMappingTable = complementaryMappingTable
)
dataMapped$pcaPlot1
dataMapped$pcaPlot2
dataMapped$heatmapPlot1
dataMapped$selectedFeatureNames
dataMapped = CohortContrast(
connection,
connectionDetails,
cdmSchema,
cdmVocabSchema,
cdmTmpSchema,
pathToResults,
studyName,
domainsIncluded = c("Condition", "Drug", "Procedure"),##c("Drug", "Condition", "Measurement", "Observation", "Procedure"),
generateTables = FALSE,
readFromCSV = FALSE,
prevalenceCutOff = 1,
topDogs = 240,
presenceFilter = 0.1,
removeOutliers = FALSE,
complementaryMappingTable = complementaryMappingTable
)
data = readRDS("/Users/markushaug/UT/R-packages/Develop/CohortContrast/tmp/datasets/TempStudy_C2G_medData.rdata")
oo = dataMapped$trajectoryData
aa = dataMapped$selectedFeatures
aaa = oo %>% group_by(SUBJECT_ID) %>% mutate(count = n())
dataMapped$selectedFeatureNames
length(unique(dataMapped$trajectoryData$COHORT_DEFINITION_ID))
#dataMapped$trajectoryData$COHORT_DEFINITION_ID = trimws(dataMapped$trajectoryData$COHORT_DEFINITION_ID)
stateCohortLabels = setdiff(unique(dataMapped$trajectoryData$COHORT_DEFINITION_ID), c("0"))
stateCohortLabels = as.vector(Cohort2Trajectory::sanitize_filenames(stateCohortLabels))
allowedStatesList = Cohort2Trajectory::createStateList(stateCohortLabels) # Creates a list allowing all transitions from each state
library(Cohort2Trajectory)
data = Cohort2Trajectory::Cohort2Trajectory(
studyName = paste(studyName, "CC", sep = "_"),
runSavedStudy = F,
stateCohortPriorityOrder = stateCohortLabels,
# Priority order of states
stateCohortMandatory = NULL,
# Mandatory states
stateCohortAbsorbing = NULL,
# Absorbing states
##############################################################################
# stateSelectionTypes
# 1 - First occurring
# 2 - Largest overlap
# 3 - Priority ordering
##############################################################################
stateSelectionType = 1,
##############################################################################
# trajectoryType
# 0 - Discrete time
# 1 - Continuous time
##############################################################################
trajectoryType = 1,
outOfCohortAllowed = T,
pathToResults = pathToResults,
useCDM = FALSE,
pathToData = NULL,
trajectoryDataObject = dataMapped$trajectoryData,
allowedStatesList = allowedStatesList,
oocFix = "None",
mergeStates = FALSE,
mergeThreshold = 0.5
)
length(unique(dataMapped$trajectoryData$SUBJECT_ID))
head(dataMapped$trajectoryData)
data = readr::read_csv("tmp/datasets/OHDSISymp2024_CCpatientDataContinuous.csv")
length(unique(data$SUBJECT_ID))
# Fill if you have your C2T table in a server or want to use remote SQL server for computing
#
server = NULL # TODO if exists
database = NULL # TODO if exists
password = NULL # TODO if exists
user = NULL # TODO if exists
port = NULL # TODO if exists
dbms = NULL # TODO if exists
schema = NULL # TODO if exists
tableName = NULL # TODO if exists
pathToDriver = './Drivers'
removeID = TRUE
removeSTART = FALSE
removeEXIT = FALSE
fixGender = TRUE
showOccurrance = FALSE
healthTrajectories::runGUI(
server = server,
database = database,
password = password,
user = user,
port = port,
dbms = dbms,
schema = schema,
pathToDriver = pathToDriver,
tableName = tableName,
removeID = removeID,
removeSTART = removeSTART,
removeEXIT = removeEXIT,
fixGender = fixGender,
showOccurrance = showOccurrance
)
devtools::install_github("https://github.com/BirgittM/healthTrajectoriesMapping")
data = readr::read_csv("tmp/datasets/finalFinal.csv")
# Assuming your dataframe is named df
df_filtered <- data %>%
group_by(SUBJECT_ID, COHORT_DEFINITION_ID) %>%
arrange(TIME_IN_COHORT) %>%
filter(row_number() == 1) %>%
ungroup()
library(dplyr)
# Assuming your dataframe is named df
df_filtered <- data %>%
group_by(SUBJECT_ID, COHORT_DEFINITION_ID) %>%
arrange(TIME_IN_COHORT) %>%
filter(row_number() == 1) %>%
ungroup()
colnames(data)
# Assuming your dataframe is named df
df_filtered <- data %>%
group_by(SUBJECT_ID, STATE_LABEL) %>%
arrange(TIME_IN_COHORT) %>%
filter(row_number() == 1) %>%
ungroup()
df_filtered
# Assuming your dataframe is named df
df_filtered <- data %>%
group_by(SUBJECT_ID, STATE_LABEL) %>%
arrange(SUBJECT_ID,TIME_IN_COHORT) %>%
filter(row_number() == 1) %>%
ungroup()
df_filtered
write.csv(df_filtered,"tmp/datasets/Final.csv" )
data = readr::read_csv("tmp/datasets/finalFinal.csv")
library(dplyr)
colnames(data)
# Assuming your dataframe is named df
df_filtered <- data %>%
group_by(SUBJECT_ID, STATE_LABEL) %>%
arrange(SUBJECT_ID,TIME_IN_COHORT) %>%
filter(row_number() == 1) %>%
ungroup()
table(df_filtered$STATE_LABEL)
table(df_filtered$STATE_LABEL)/length(unique(df_filtered$SUBJECT_ID))
View(df_filtered)
# Assuming your dataframe is named df
df_filtered <- data %>%
group_by(SUBJECT_ID, STATE_LABEL) %>%
arrange(SUBJECT_ID,TIME_IN_COHORT) %>%
filter(row_number() == 1) %>%
ungroup()
subject_ids_with_specific_states <- df_filtered %>%
filter(state_label %in% c("ICS_all", "SABA_all", "LABA_all")) %>%
distinct(SUBJECT_ID)
subject_ids_with_specific_states <- df_filtered %>%
filter(STATE_LABEL %in% c("ICS_all", "SABA_all", "LABA_all")) %>%
distinct(SUBJECT_ID)
# Then, filter the original dataset to keep all information for these SUBJECT_IDs
df_filtered <- df_filtered %>%
semi_join(subject_ids_with_specific_states, by = "SUBJECT_ID")
table(df_filtered$STATE_LABEL)/length(unique(df_filtered$SUBJECT_ID))
nrow(df_filtered)
# Assuming your dataframe is named df
df_filtered <- data %>%
group_by(SUBJECT_ID, STATE_LABEL) %>%
arrange(SUBJECT_ID,TIME_IN_COHORT) %>%
filter(row_number() == 1) %>%
ungroup()
nrow(df_filtered)
subject_ids_with_specific_states <- df_filtered %>%
filter(STATE_LABEL %in% c("ICS_all", "SABA_all", "LABA_all")) %>%
distinct(SUBJECT_ID)
# Then, filter the original dataset to keep all information for these SUBJECT_IDs
df_filtered <- df_filtered %>%
semi_join(subject_ids_with_specific_states, by = "SUBJECT_ID")
table(df_filtered$STATE_LABEL)/length(unique(df_filtered$SUBJECT_ID))
df_filtered = df_filtered %>% filter(STATE_LABEL %in% c("ICS_all", "SABA_all", "LABA_all","Anti-Inflammatory", "Cardiovascular_Asses", "Cardiovascular","Gastrointestinal", "Respiratory_Conditio", "Antihistamine"))
table(df_filtered$STATE_LABEL)/length(unique(df_filtered$SUBJECT_ID))
nrow(df_filtered)
write.csv(df_filtered,"tmp/datasets/Final.csv" )
readRDS("./tmp/datasets/TempStudy_C2G_medData.rdata")
file.exists("./tmp/datasets/TempStudy_C2G_medData.rdata")
load("./tmp/datasets/TempStudy_C2G_medData.rdata")
View(object)
object$data_features
devtools::load_all()
devtools::build()
devtools::document()
